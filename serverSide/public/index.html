<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Course Registration Advisor System</title>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        color: white;
      }

      .header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .upload-card {
        background: white;
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        transition: transform 0.3s ease;
      }

      .upload-card:hover {
        transform: translateY(-5px);
      }

      .upload-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
      }

      .upload-item {
        background: #f8f9ff;
        border: 2px dashed #ddd;
        border-radius: 15px;
        padding: 25px;
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
        overflow: hidden;
      }

      .upload-item:hover {
        border-color: #667eea;
        background: #f0f4ff;
        transform: scale(1.02);
      }

      .upload-item.has-file {
        border-color: #28a745;
        background: #f0fff4;
      }

      .upload-item input[type="file"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .upload-icon {
        font-size: 3rem;
        color: #667eea;
        margin-bottom: 15px;
      }

      .upload-item.has-file .upload-icon {
        color: #28a745;
      }

      .upload-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .upload-subtitle {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 15px;
      }

      .file-info {
        background: white;
        padding: 10px;
        border-radius: 8px;
        margin-top: 15px;
        font-size: 0.9rem;
        color: #333;
      }

      .submit-section {
        text-align: center;
        margin-top: 30px;
      }

      .submit-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 10px 30px rgba(40, 167, 69, 0.3);
      }

      .submit-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 15px 40px rgba(40, 167, 69, 0.4);
      }

      .submit-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .loading {
        display: none;
        text-align: center;
        margin: 30px 0;
        color: #667eea;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .results {
        margin-top: 30px;
      }

      .results-card {
        background: white;
        border-radius: 20px;
        padding: 30px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .progress-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .student-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
      }

      .info-item {
        text-align: center;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        backdrop-filter: blur(10px);
      }

      .info-value {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .info-label {
        font-size: 0.9rem;
        opacity: 0.9;
      }

      .progress-bar {
        width: 100%;
        height: 10px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 5px;
        overflow: hidden;
        margin: 20px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 5px;
        transition: width 0.5s ease;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .progress-card .section-title {
        color: white;
      }

      .course-grid {
        display: grid;
        gap: 15px;
      }

      .course-card {
        background: #f8f9ff;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
      }

      .course-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      }

      .course-card.high-priority {
        border-left: 5px solid #28a745;
        background: #f0fff4;
      }

      .course-card.medium-priority {
        border-left: 5px solid #ffc107;
        background: #fffbf0;
      }

      .course-card.low-priority {
        border-left: 5px solid #6c757d;
        background: #f8f9fa;
      }

      .course-card.missed {
        border-left: 5px solid #dc3545;
        background: #fff5f5;
      }

      .course-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 10px;
      }

      .course-code {
        font-size: 1.1rem;
        font-weight: 700;
        color: #333;
      }

      .priority-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .priority-high {
        background: #d4edda;
        color: #155724;
      }

      .priority-medium {
        background: #fff3cd;
        color: #856404;
      }

      .priority-low {
        background: #e2e3e5;
        color: #383d41;
      }

      .course-title {
        font-size: 1rem;
        color: #666;
        margin-bottom: 10px;
        line-height: 1.4;
      }

      .course-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 10px;
        font-size: 0.85rem;
        color: #666;
      }

      .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .course-reason {
        font-size: 0.85rem;
        color: #667eea;
        font-style: italic;
        margin-top: 8px;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #f5c6cb;
        margin: 20px 0;
      }

      .alert {
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
      }

      .tab {
        padding: 12px 24px;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1rem;
        color: #666;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
      }

      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
        font-weight: 600;
      }

      .tab:hover {
        color: #667eea;
        background: #f8f9ff;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }

        .upload-card {
          padding: 25px;
        }

        .upload-grid {
          grid-template-columns: 1fr;
        }

        .student-info {
          grid-template-columns: repeat(2, 1fr);
        }

        .header h1 {
          font-size: 2rem;
        }

        .tabs {
          flex-wrap: wrap;
        }

        .tab {
          flex: 1;
          text-align: center;
        }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>
          <i class="fas fa-graduation-cap"></i> Course Registration Advisor
        </h1>
        <p>
          Get intelligent course recommendations based on your academic progress
        </p>
      </div>

      <div class="upload-card">
        <h2 class="section-title">
          <i class="fas fa-upload"></i>
          Upload Required Documents
        </h2>

        <form id="uploadForm" enctype="multipart/form-data">
          <div class="upload-grid">
            <div
              class="upload-item"
              onclick="document.getElementById('curriculum').click()"
            >
              <input
                type="file"
                id="curriculum"
                name="curriculum"
                accept=".docx,.txt,.pdf"
                required
              />
              <div class="upload-icon">
                <i class="fas fa-book"></i>
              </div>
              <div class="upload-title">Course Curriculum</div>
              <div class="upload-subtitle">
                Upload your program's course curriculum (.docx, .txt, .pdf)
              </div>
              <div
                class="file-info"
                id="curriculum-info"
                style="display: none"
              ></div>
            </div>

            <div
              class="upload-item"
              onclick="document.getElementById('transcript').click()"
            >
              <input
                type="file"
                id="transcript"
                name="transcript"
                accept=".xlsx,.xls,.pdf"
                required
              />
              <div class="upload-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="upload-title">Student Transcript</div>
              <div class="upload-subtitle">
                Upload your academic transcript (.xlsx, .xls, .pdf)
              </div>
              <div
                class="file-info"
                id="transcript-info"
                style="display: none"
              ></div>
            </div>

            <div
              class="upload-item"
              onclick="document.getElementById('availableCourses').click()"
            >
              <input
                type="file"
                id="availableCourses"
                name="availableCourses"
                accept=".docx,.txt"
                required
              />
              <div class="upload-icon">
                <i class="fas fa-list"></i>
              </div>
              <div class="upload-title">Available Courses</div>
              <div class="upload-subtitle">
                Upload available courses for this semester (.docx, .txt)
              </div>
              <div
                class="file-info"
                id="availableCourses-info"
                style="display: none"
              ></div>
            </div>
          </div>

          <div class="submit-section">
            <button type="submit" class="submit-btn" id="submitBtn" disabled>
              <i class="fas fa-magic"></i> Generate Course Recommendations
            </button>
          </div>
        </form>

        <div class="loading" id="loading">
          <div class="loading-spinner"></div>
          <p>Processing your documents and generating recommendations...</p>
        </div>
      </div>

      <div id="results" class="results"></div>
    </div>

    <script>
      // File upload handling
      const fileInputs = ["curriculum", "transcript", "availableCourses"];
      let uploadedFiles = {};

      fileInputs.forEach((inputId) => {
        const input = document.getElementById(inputId);
        const uploadItem = input.closest(".upload-item");
        const fileInfo = document.getElementById(inputId + "-info");

        input.addEventListener("change", function (e) {
          const file = e.target.files[0];
          if (file) {
            uploadedFiles[inputId] = file;
            uploadItem.classList.add("has-file");
            fileInfo.innerHTML = `<i class="fas fa-check-circle"></i> ${
              file.name
            } (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
            fileInfo.style.display = "block";
          } else {
            delete uploadedFiles[inputId];
            uploadItem.classList.remove("has-file");
            fileInfo.style.display = "none";
          }
          updateSubmitButton();
        });
      });

      function updateSubmitButton() {
        const submitBtn = document.getElementById("submitBtn");
        const allFilesUploaded = fileInputs.every(
          (inputId) => uploadedFiles[inputId]
        );
        submitBtn.disabled = !allFilesUploaded;
      }

      // Form submission
      document
        .getElementById("uploadForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const loading = document.getElementById("loading");
          const results = document.getElementById("results");
          const submitBtn = document.getElementById("submitBtn");

          loading.style.display = "block";
          results.innerHTML = "";
          submitBtn.disabled = true;

          const formData = new FormData(this);

          try {
            // Step 1: Parse and save documents to JSON
            const parseResponse = await fetch("/api/parse-and-save", {
              method: "POST",
              body: formData,
            });

            const parseData = await parseResponse.json();

            if (parseData.success) {
              // Step 2: Load from JSON and generate recommendations
              const recommendResponse = await fetch("/api/load-and-recommend", {
                method: "POST",
              });

              const recommendData = await recommendResponse.json();

              loading.style.display = "none";
              submitBtn.disabled = false;

              if (recommendData.success) {
                displayResults(recommendData);
              } else {
                results.innerHTML = `<div class="error fade-in"><i class="fas fa-exclamation-triangle"></i> Error generating recommendations: ${
                  recommendData.message || recommendData.error
                }</div>`;
              }
            } else {
              loading.style.display = "none";
              submitBtn.disabled = false;
              results.innerHTML = `<div class="error fade-in"><i class="fas fa-exclamation-triangle"></i> Error parsing documents: ${
                parseData.message || parseData.error
              }</div>`;
            }
          } catch (error) {
            loading.style.display = "none";
            submitBtn.disabled = false;
            results.innerHTML = `<div class="error fade-in"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
          }
        });

      function displayResults(data) {
        const results = document.getElementById("results");
        const { progressReport, recommendations } = data;

        let html = "";

        // Progress Report Card
        html += `
                <div class="results-card progress-card fade-in">
                    <h2 class="section-title">
                        <i class="fas fa-chart-line"></i>
                        Academic Progress Report
                    </h2>
                    
                    <div class="student-info">
                        <div class="info-item">
                            <div class="info-value">${
                              progressReport.currentSemester
                            }</div>
                            <div class="info-label">Current Semester</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value">${
                              progressReport.completedCourses
                            }</div>
                            <div class="info-label">Completed Courses</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value">${
                              progressReport.totalECTS
                            }</div>
                            <div class="info-label">Total ECTS</div>
                        </div>
                        <div class="info-item">
                            <div class="info-value">${
                              progressReport.completionPercentage
                            }%</div>
                            <div class="info-label">Program Completion</div>
                        </div>
                    </div>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${
                          progressReport.completionPercentage
                        }%"></div>
                    </div>
                    
                    <p style="text-align: center; opacity: 0.9;">
                        <strong>${
                          progressReport.studentInfo.name || "Student"
                        }</strong> - 
                        ${
                          progressReport.studentInfo.program ||
                          "Computer Engineering"
                        }
                    </p>
                </div>
            `;

        // Recommendations Card
        html += `
                <div class="results-card fade-in">
                    <h2 class="section-title">
                        <i class="fas fa-lightbulb"></i>
                        Course Recommendations
                    </h2>
                    
                    <div class="tabs">
                        <button class="tab active" onclick="switchTab(event, 'next-semester')">
                            <i class="fas fa-star"></i> Next Semester
                        </button>
                        <button class="tab" onclick="switchTab(event, 'electives')">
                            <i class="fas fa-graduation-cap"></i> Electives
                        </button>
                        <button class="tab" onclick="switchTab(event, 'missed')">
                            <i class="fas fa-exclamation-triangle"></i> Missed Courses
                        </button>
                    </div>
            `;

        // Next Semester Tab
        html += '<div id="next-semester" class="tab-content active">';
        if (recommendations.nextSemesterCourses.length > 0) {
          html += '<div class="course-grid">';
          recommendations.nextSemesterCourses.slice(0, 8).forEach((course) => {
            const priorityClass =
              course.priority >= 10
                ? "high-priority"
                : course.priority >= 5
                ? "medium-priority"
                : "low-priority";
            const priorityBadge =
              course.priority >= 10
                ? "priority-high"
                : course.priority >= 5
                ? "priority-medium"
                : "priority-low";
            const priorityText =
              course.priority >= 10
                ? "High"
                : course.priority >= 5
                ? "Medium"
                : "Low";

            html += `
                        <div class="course-card ${priorityClass}">
                            <div class="course-header">
                                <div class="course-code">${course.code}</div>
                                <span class="priority-badge ${priorityBadge}">${priorityText} Priority</span>
                            </div>
                            <div class="course-title">${course.title}</div>
                            <div class="course-meta">
                                <div class="meta-item">
                                    <i class="fas fa-tag"></i>
                                    ${course.category}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-credit-card"></i>
                                    ${course.totalCredit} Credits
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-certificate"></i>
                                    ${course.ects} ECTS
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-calendar"></i>
                                    Semester ${course.semester}
                                </div>
                            </div>
                            <div class="course-reason">
                                <i class="fas fa-info-circle"></i>
                                ${course.reason}
                            </div>
                        </div>
                    `;
          });
          html += "</div>";
        } else {
          html +=
            '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No courses available for next semester registration.</div>';
        }
        html += "</div>";

        // Electives Tab
        html += '<div id="electives" class="tab-content">';
        if (recommendations.availableElectives.length > 0) {
          html += '<div class="course-grid">';
          recommendations.availableElectives.slice(0, 6).forEach((course) => {
            html += `
                        <div class="course-card">
                            <div class="course-header">
                                <div class="course-code">${course.code}</div>
                                <span class="priority-badge priority-low">Elective</span>
                            </div>
                            <div class="course-title">${course.title}</div>
                            <div class="course-meta">
                                <div class="meta-item">
                                    <i class="fas fa-tag"></i>
                                    ${course.category}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-credit-card"></i>
                                    ${course.totalCredit} Credits
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-certificate"></i>
                                    ${course.ects} ECTS
                                </div>
                            </div>
                        </div>
                    `;
          });
          html += "</div>";
        } else {
          html +=
            '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No elective courses available at this time.</div>';
        }
        html += "</div>";

        // Missed Courses Tab
        html += '<div id="missed" class="tab-content">';
        if (recommendations.missedCourses.length > 0) {
          html += '<div class="course-grid">';
          recommendations.missedCourses.forEach((course) => {
            html += `
                        <div class="course-card missed">
                            <div class="course-header">
                                <div class="course-code">${course.code}</div>
                                <span class="priority-badge priority-high">Urgent</span>
                            </div>
                            <div class="course-title">${course.title}</div>
                            <div class="course-meta">
                                <div class="meta-item">
                                    <i class="fas fa-tag"></i>
                                    ${course.category}
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-credit-card"></i>
                                    ${course.totalCredit} Credits
                                </div>
                                <div class="meta-item">
                                    <i class="fas fa-certificate"></i>
                                    ${course.ects} ECTS
                                </div>
                            </div>
                            <div class="course-reason">
                                <i class="fas fa-exclamation-triangle"></i>
                                Should have been taken in Semester ${course.semester}
                            </div>
                        </div>
                    `;
          });
          html += "</div>";
        } else {
          html +=
            '<div class="alert alert-info"><i class="fas fa-check-circle"></i> Great! You haven\'t missed any required courses.</div>';
        }
        html += "</div>";

        html += "</div>"; // Close recommendations card

        results.innerHTML = html;
        results.scrollIntoView({ behavior: "smooth" });
      }

      function switchTab(evt, tabName) {
        // Hide all tab contents
        const tabContents = document.querySelectorAll(".tab-content");
        tabContents.forEach((content) => {
          content.classList.remove("active");
        });

        // Remove active class from all tabs
        const tabs = document.querySelectorAll(".tab");
        tabs.forEach((tab) => {
          tab.classList.remove("active");
        });

        // Show selected tab content and mark tab as active
        document.getElementById(tabName).classList.add("active");
        evt.currentTarget.classList.add("active");
      }

      // Prevent default drag behavior
      document.addEventListener("dragover", function (e) {
        e.preventDefault();
      });

      document.addEventListener("drop", function (e) {
        e.preventDefault();
      });
    </script>
  </body>
</html>
